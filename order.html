<!DOCTYPE html>
<html>

<head>
	<link rel="stylesheet" type="text/css" href="order.css">
    <link rel="stylesheet" type="text/css" media="screen" href="css/wed_product.css" />
	<script src="js/pouchDb.js"></script>
</head>

<body>
	<div class="header">
		<div class="row clearfix">
			<div class="leftmenu">
				<h2> BAKE N SHAKE </h2>
			</div>
			<div class="main">
				<ul class="navmenu">
					<li><a href="index.html" target="_self">HOME</a></li>
					<li><a href="about_us.html" target="_self">ABOUT US</a></li>
					<li>CAKES
						<ul class="sub-menu">
							<li><a href="wedding.html" target="_self">WEDDING</a></li>
							<li><a href="3dcakes.html" target="_self">3D CAKES</a></li>
							<li><a href="all-cakes.html" target="_self">REGULAR CAKES</a></li>
							<li><a href="all-cakes.html" target="_self">CUSTOM CAKES</a></li>
						</ul>
					</li>
					<li>PASTRIES
						<ul class="sub-menu">
							<li><a href="pastries.html" target="_self">PASTRIES</a></li>
							<li><a href="cupcakes.html" target="_self">CUP CAKES</a></li>
						</ul>
					</li>
					<li><a href="contact_us.html" target="_self">CONTACT US</a></li>
					<li><a href="feedback.html" target="_self">FEEDBACK</a></li>
				</ul>
			</div>
		</div>
	</div>
	<div class="main-container">
		<center>
			<caption>
				REVIEW YOUR SHOPPING CART</caption><br><br><br>
	
			<table border="1" cellpadding="10">
				<thead>
					<tr>
						<th>PRODUCT</th>
						<th>DETAILS</th>
						<th>OPTIONS</th>
						<th>UNIT PRICE</th>
						<th>TOTAL</th>
					</tr>
				</thead>
				<tbody id="cart-body">
				</tbody>
	
				<tr>
					<td colspan=3>
						Enter your Postal Code &nbsp&nbsp
						<input type="text" name="name">
						&nbsp&nbsp&nbsp
						<input type="button" value="calculate my delivery charge" name="calculate my delivery charge">
						or
						<input type="button" value="Pick Up" name="Pick Up">
					</td>
	
					<td></td>
					<td></td>
				</tr>
	
				<tr>
					<td>All prices are inclusive of GST</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
	
	
				<tr>
					<td colspan=2>
						Enter a Promo Code (optional)&nbsp&nbsp
						<input id="discount-input" type="text" name="name">
						&nbsp&nbsp&nbsp
						<input type="button" value="Apply" name="Apply" onclick="setDiscount()">
					</td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
	
				<tr>
					<td colspan=3></td>
					<td>Subtotal:</td>
					<td id="subtotal"></td>
				</tr>
	
				<tr>
					<td colspan=3></td>
					<td>Discount:</td>
					<td id="discount"></td>
				</tr>
	
				<tr>
					<td colspan=3></td>
					<td>Total: </td>
					<td id="total"></td>
				</tr>
			</table>
		</center>
	</div>

	<script>
		var dbCart = new PouchDB('cart');
		var cartBody = document.getElementById('cart-body');
		var subTotalEement = document.getElementById('subtotal');
		var totalEement = document.getElementById('total');
		var discountEement = document.getElementById('discount');
		var discountInput = document.getElementById('discount-input');
		var cartItems = [];
		var subTotal = 0;
		var discount = 0;
		var promoCodes = {
			'flat10': 10,
			'flat50': 50,
			'free': subTotal
		}

		var getAllItems = function () {
			dbCart.allDocs({ include_docs: true, descending: true }, function (err, doc) {
				console.log('All cart items', doc);
				cartItems = doc.rows;
				updateCart();
			});
		}

		getAllItems();

		var updateCart = function () {
			cartBody.innerHTML = '';
			var local_subtotal = 0;
			for (let index = 0; index < cartItems.length; index++) {
				const item = cartItems[index];
				local_subtotal += item.doc.price;
				cartBody.innerHTML += `
			<tr>
				<td>
					<p>${item.doc.name}</p>
					<img class="img-cart-item" src="${item.doc.image}" alt="cake">
				</td>
				<td>
					<p> <span>Weight: </span>${item.doc.weight} Kg</p>
				</td>
				<td>
					<a style="cursor: pointer;" onclick="removeFromCart('${item.doc._id}')">Remove</a>
				</td>
				<td>
					<p>Rs. ${item.doc.price}</p>
				</td>
				<td>
					<p>Rs. ${item.doc.price}</p>
				</td>
			</tr>
		`;
				//tamplet literal(`) 
			}
			subTotal = local_subtotal;
			updateTotals();
		}

		var updateTotals = function () {
			subTotalEement.innerText = subTotal;
			promoCodes.free = subTotal;
			discountEement.innerText = discount;
			totalEement.innerText = subTotal - discount;
		}

		var setDiscount = function () {
			var promoKey = discountInput.value.toLowerCase();
			if (promoCodes[promoKey]) {
				discount = promoCodes[promoKey];
			} else {
				discount = 0;
				discountInput.value = ''
			}
			updateTotals();
		}

		var removeFromCart = async function (id) {
			console.log('removing data');
			try {
				var doc = await dbCart.get(id);
				var response = await dbCart.remove(doc);
				console.log('delete responce...', response);

				if (response) {
					getAllItems();
				}
			} catch (err) {
				console.log(err);
			}
		}

	</script>


</body>

</html>